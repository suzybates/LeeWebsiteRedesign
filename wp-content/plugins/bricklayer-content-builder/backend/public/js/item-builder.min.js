/*! 08-10-2013 by krivinarius@gmail.com */
!function(a,b){"use strict";var c=b.cbp_content_builder,d=c.data.helpers,e=c.data.sliders,f="block_slider_container",g="block_slider",h="block_slider_row",i="block_slider_slide",j="block_slider_item";Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(a){var b=this.__proto__||this.constructor.prototype;return a in this&&(!(a in b)||b[a]!==this[a])}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;for(c=0,d=this.length;d>c;++c)c in this&&a.call(b,this[c],c,this)});var k={};k.isRow=function(a){return a.hasClass(h)},k.isBox=function(a){return a.hasClass(TAG_BOX)},k.hasChildren=function(a){return a.children().length},k.idCounter=0,k.uniqueId=function(a){var b=++this.idCounter+"";return a?a+b:b},k.resetIdCounter=function(){this.idCounter=0},k.getRegex=function(a){return wp.shortcode.regexp(a)},d.stripslashes=k.stripslashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},d.strip_tags=k.strip_tags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},d.trimmer=k.trimmer=function(a,b,c){var c=c||"...";return a?this.strip_tags(a.substring(0,b))+c:void 0},d.prefixize=k.prefixize=function(a){return"towpb_"+a},d.deprefixize=k.deprefixize=function(a){return"string"==typeof a?a.replace("towpb_",""):void 0},d.removeTinymceIdWrap=k.removeTinymceIdWrap=function(a){if("string"==typeof a){var b=a.replace("wp-","");return b.replace("-wrap","")}},d.stripWrappingTags=k.stripWrappingTags=function(a){return"string"==typeof a?(a=a.replace("<p>[","["),a=a.replace("]</p>","]"),a=a.replace("<p></p>",""),a=a.replace("]<br />","]")):void 0},Backbone.Model.extend({getInstanceById:function(a){return"undefined"!=typeof tinyMCE?tinyMCE.getInstanceById(a):void 0},getContent:function(){var b,c=null;return c="undefined"!=typeof tinyMCE&&(b=this.getInstanceById("content"))&&!b.isHidden()?b.getContent():a("#content").val(),c?c:void 0},replaceTags:function(b){var c=this.getContent(),d=this.getInstanceById("content");b=this.wrapInMainTags(b),this.tagExist(TAG_MAIN,c)?(c=c.replace(k.getRegex(TAG_MAIN),b),d?d.setContent(c):a("#content").val(c)):d.execCommand("mceInsertContent",!1,b)},tagExist:function(a,b){var c=wp.shortcode.next(TAG_MAIN,b);return c?!0:!1},wrapInMainTags:function(a){return"["+TAG_MAIN+"]"+a+"[/"+TAG_MAIN+"]"}});var l=Backbone.Model.extend({defaults:{name:"",shortcode:null,position:1e4,type:"",data:{},parentId:null,parentRoute:"",childRoute:""},initialize:function(){this.id||(this.id=this.generateID(),this.set("id",this.generateID()))},generateID:function(){return"_"+Math.random().toString(36).substr(2,9)},getChildrenCount:function(){return u.where({parentId:this.id}).length}}),m=Backbone.Router.extend({routes:{sliders:"sliders","delete/:type/:id":"deleteItem","rows/:slider_id":"rows","slides/:row_id":"slides","items/:slide_id":"items","edit/:type/:id":"edit"},sliders:function(){var a="slider",b="rows",c=u.where({type:a}),d=_.sortBy(c,function(a){return a.get("position")});v.append(A.render(d,b).el),z.render({type:a,childRoute:b}),y.render().$el.append("<li>sliders</li>")},rows:function(a){var b=u.get(a),c="row",d="slides",e=u.where({type:c,parentId:a}),f=_.sortBy(e,function(a){return a.get("position")});v.append(A.render(f,d).el),z.render({type:c,parentId:a,childRoute:d}),y.render(a).$el.append("<li>"+b.get("name")+": rows"+"</li>")},slides:function(a){var b=u.get(a),c="slide",d="items",e=u.where({type:c,parentId:a}),f=_.sortBy(e,function(a){return a.get("position")});v.append(A.render(f,d).el),z.render({type:c,parentId:a,childRoute:d}),y.render(a).$el.append("<li>"+b.get("name")+": slides"+"</li>")},items:function(a){var b=u.get(a),c="item",d=u.where({type:c,parentId:a}),e=_.sortBy(d,function(a){return a.get("position")});v.append(A.render(e).el),z.render({type:c,parentId:a}),y.render(a).$el.append("<li>"+b.get("name")+": items"+"</li>")},edit:function(a,b){var c=u.get(b);w.render(c),w.$el.show()},deleteItem:function(a,b){if(confirm("Are you sure you want to delete this item?")){var c=u.get(b);u.deleteBranch(c),c.get("parentId")?this.navigate(a+"s/"+c.get("parentId"),{trigger:!0,replace:!0}):this.navigate("sliders",{trigger:!0,replace:!0})}}}),n=Backbone.View.extend({el:"#breadcrumbs",initialize:function(){this.template=_.template(a("#breadcrumbs_template").html())},render:function(b){function c(a){var b="",e="",f=u.get(a);if(f){f.get("parentId")?(c(f.get("parentId")),b=f.get("type")+"s/"+f.get("parentId")):b=f.get("type")+"s";var g=u.get(f.get("parentId"));g&&(e=g.get("name")+": "),d.push({name:e+f.get("type")+"s",url:b})}}var d=[];return c(b),this.$el.html(this.template({helpers:k,breadcrumbs:d,partial:function(b,c){return _.template(a("#"+b).html(),c)}})),this}}),o=Backbone.View.extend({el:"#create-item",initialize:function(){this.template=_.template(a("#create_item_template").html())},render:function(b){var b=b||{};return this.$el.html(this.template({helpers:k,options:b,partial:function(b,c){return _.template(a("#"+b).html(),c)}})),this},events:{"click #add-item":"add"},add:function(a){a.preventDefault();var b,c=this.$("#new-item-name"),d=c.val().trim(),e=c.data("type"),f=c.data("parentid")?c.data("parentid"):null,g=c.data("childroute")?c.data("childroute"):null,h=u.where({name:d,type:e,parentId:f});if(h[0])return alert(e.charAt(0).toUpperCase()+e.slice(1)+" by that name already exists"),void 0;d?b=new l({name:d,type:e,parentId:f,childRoute:g}):alert("Name is missing"),u.add(b);var i=u.where({type:e,parentId:f}),j=_.sortBy(i,function(a){return a.get("position")});v.prepend(A.render(j,g).el),c.val("")}}),p=Backbone.View.extend({el:"#item-form",initialize:function(){this.template=_.template(a("#item_form_template").html())},render:function(b){this.model=b;var b=this.model?this.model.toJSON():{name:"",type:null};return this.$el.html(this.template({model:b,helpers:k,partial:function(b,c){return _.template(a("#"+b).html(),c)}})),this},events:{"click #save-item":"saveItem","click .item-form-close":"close"},saveItem:function(a){a.preventDefault();var b=this;if(this.model){_.each(this.$el.serializeArray(),function(a){b.model.set(a.name.trim(),a.value.trim())});var c=u.where({type:this.model.get("type"),parentId:this.model.get("parentId")});v.prepend(A.render(c,this.model.get("childRoute")).el)}this.close()},close:function(){this.$el.hide(),b.history.back()}}),q=Backbone.View.extend({tagName:"ol",attributes:{id:"item-list"},initialize:function(){this.$el.sortable({stop:function(){A.$el.children().each(function(){a(this).trigger("change:position")})}})},render:function(a,b){var c=this;return this.clear(),a.forEach(function(a){var d=null,e=new r({model:a});b&&a.id&&(d=b+"/"+a.id),c.$el.append(e.render(d).el)}),this},clear:function(){this.$el.html("")}}),r=Backbone.View.extend({tagName:"li",attributes:{"class":"list-item"},initialize:function(){this.template=_.template(a("#item_template").html())},render:function(b){return this.$el.html(this.template({model:this.model.toJSON(),helpers:k,hash:b,childrenCount:this.model.getChildrenCount(),modelId:this.model.id,partial:function(b,c){return _.template(a("#"+b).html(),c)}})),this},events:{"change:position":"setPosition"},setPosition:function(){this.model.set("position",this.$el.index())}}),s=Backbone.View.extend({el:"#save-all-form",initialize:function(){this.template=_.template(a("#save_all_form_template").html())},render:function(){return this.$el.html(this.template({helpers:k,partial:function(b,c){return _.template(a("#"+b).html(),c)}})),this},events:{"click #save-all":"saveAll"},saveAll:function(b){b.preventDefault();var c=this;A.$el.children().each(function(){a(this).trigger("change:position")});var d=u.where({type:"slider"});d.forEach(function(a){c.makeShortcodes(a)}),Backbone.sync("create",u,{success:function(){},error:function(){}})},makeShortcodes:function(a){function b(a){if(a.id){var d=a.get("type");if("slider"===d&&(c+="["+f+' id="slider'+a.id+'"]['+g+"]"),"row"===d&&(c+="["+h+"]"),"slide"===d&&(c+="["+i+"]"),"item"===d){c+="["+j;for(var e in a.attributes)("item_image_src"===e||"item_image_width"===e)&&(c+=" "+e+'="'+a.attributes[e]+'"');c+="]"}var k=u.where({parentId:a.id});if(k){var l=_.sortBy(k,function(a){return a.get("position")});l.forEach(function(a){b(a)})}"item"===d&&(c+="[/"+j+"]"),"slide"===d&&(c+="[/"+i+"]"),"row"===d&&(c+="[/"+h+"]"),"slider"===d&&(c+="[/"+g+"][/"+f+"]")}}var c="";b(a),a.set("shortcode",c)}}),t=Backbone.Collection.extend({url:ajaxurl+"?action=slideBuilderAjax",model:l,comparator:function(a){return a.get("position")},deleteBranch:function(a){var b=this;if(a.id){var c=this.where({parentId:a.id});c&&c.forEach(function(a){b.deleteBranch(a)}),this.remove(a)}}}),u=new t(e),v=a("#items-container"),w=new p,x=new s,y=new n,z=new o,A=new q;x.render();var B=new m;Backbone.history.start(),B.navigate("sliders",{trigger:!0,replace:!0})}(jQuery,window,document);
