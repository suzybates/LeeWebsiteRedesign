/*! 18-12-2014 by krivinarius@gmail.com */
!function(a,b){"use strict";a(function(){function c(a){return m.hasOwnProperty(a)?m[a]:{}}var d="cbp",e=d,f=d+"_widget_row",g=d+"_widget_row_inner",h=d+"_widget_box",i=d+"_widget_element",j=d+"-widget",k=b.cbp_content_builder,l=(k.data.temp,k.data.helpers),m=k.data.widgets,n=k.data.widthClasses,o=k.data.widthClassesObj,p=(k.data.templates,k.data.bl_is_enabled);Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(a){var b=this.__proto__||this.constructor.prototype;return a in this&&(!(a in b)||b[a]!==this[a])}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;for(c=0,d=this.length;d>c;++c)c in this&&a.call(b,this[c],c,this)});var q={};q.template=function(a,b){var c={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},b=b||null;return _.template(a,b,c)},q.isRow=function(a){return a.hasClass(f)},q.isRowInner=function(a){return a.hasClass(g)},q.isBox=function(a){return a.hasClass(h)},q.hasChildren=function(a){return a.children().length},q.idCounter=0,q.uniqueId=function(a){var b=++this.idCounter+"";return a?a+b:b},q.resetIdCounter=function(){this.idCounter=0},q.getRegex=function(a){return wp.shortcode.regexp(a)},q.wpautop=function(b){return a.trim(b)?switchEditors.wpautop(b):" "},l.stripslashes=q.stripslashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},l.strip_tags=q.strip_tags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},l.trimmer=q.trimmer=function(a,b,c){var c=c||"...";return a?(a.length<=b&&(c=""),this.strip_tags(a.substring(0,b))+c):void 0},l.prefixize=q.prefixize=function(a){return d+"_"+a},l.deprefixize=q.deprefixize=function(a){return"string"==typeof a?a.replace(d+"_",""):void 0},l.removeTinymceIdWrap=q.removeTinymceIdWrap=function(a){if("string"==typeof a){var b=a.replace("wp-","");return b.replace("-wrap","")}},l.stripWrappingTags=q.stripWrappingTags=function(a){return"string"==typeof a?(a=a.replace(/<p>\[/g,"["),a=a.replace(/<p>\s\[/g,"["),a=a.replace(/\]<\/p>/g,"]"),a=a.replace(/\]\s<\/p>/g,"]"),a=a.replace(/<p><\/p>/g,""),a=a.replace(/<p>\s<\/p>/g,""),a=a.replace(/]<br>/g,"]"),a=a.replace(/]\s<br>/g,"]"),a=a.replace(/]<br \/>/g,"]"),a=a.replace(/]\s<br \/>/g,"]"),"</p>\n"===a.substr(0,5)&&(a=a.slice(5)),"<p>\n"===a.substr(-4,4)&&(a=a.slice(0,-4)),"</p>"===a.substr(0,4)&&(a=a.slice(4)),"<p>"===a.substr(-3,3)&&(a=a.slice(0,-3)),a):void 0};var r=Backbone.Model.extend({defaults:{},initialize:function(){k.data.api={},k.data.api.updatePageBuilder=this.updatePageBuilder},updatePageBuilder:function(){F.render()}}),s=Backbone.Model.extend({defaults:{el:null,parentElements:null,dependentElements:null,parentDataType:"triggerparent",childDataType:"triggerchild"},initialize:function(){this.setParentElements(),this.setDependentElements(),this.setInitialStates()},setParentElements:function(){var a=this.get("el").find('[data-type="'+this.get("parentDataType")+'"]');this.set("parentElements",a)},setDependentElements:function(){var a=this.get("el").find('[data-type="'+this.get("childDataType")+'"]');this.set("dependentElements",a)},setInitialStates:function(){var b=this;this.get("dependentElements").each(function(){var c=a(this),d=c.data("parent"),e=c.data("parentstate"),f=b.getParentElement(d);b.setState(c.parents(".cbp_form_element_wrapper"),""+e==""+f.val()),b.registerParentOnChangeEvent(f)})},setState:function(a,b){b?this.show(a):this.hide(a)},getParentElement:function(a){var b=this.get("parentElements").filter('[data-name="'+a+'"]');return b},getChildrenElements:function(a){var b=this.get("dependentElements").filter('[data-parent="'+a+'"]');return b},registerParentOnChangeEvent:function(b){var c=this;b.on("change",function(){var d=c.getChildrenElements(b.data("name"));d.each(function(){var d=a(this);c.setState(d.parents(".cbp_form_element_wrapper"),""+d.data("parentstate")==""+b.val())})})},show:function(a){a.fadeIn()},hide:function(a){a.fadeOut()}}),t=Backbone.Model.extend({getInstanceById:function(a){return"undefined"!=typeof tinyMCE?tinyMCE.get(a):void 0},getContent:function(){var b,c=null;return c="undefined"!=typeof tinyMCE&&(b=this.getInstanceById("content"))&&!b.isHidden()?b.getContent():a("#content").val(),c?c:void 0},replaceTags:function(b){var c=this.getContent(),d=this.getInstanceById("content");b=this.wrapInMainTags(b),this.tagExist(e,c)?(c=c.replace(q.getRegex(e),b),d?d.setContent(c):a("#content").val(c)):d.execCommand("mceInsertContent",!1,b)},tagExist:function(a,b){var c=wp.shortcode.next(e,b);return c?!0:!1},wrapInMainTags:function(a){return"["+e+"]"+a+"[/"+e+"]"}}),u=Backbone.Model.extend({defaults:{specialTags:[f,g,h],iconClass:"fa fa-font fa-3x",iconImg:""},initialize:function(){this.widgetParadigm=c(this.getAttr("type")),this.setIconClass(),this.setIconImg(),this.setName(),this.setWidth(),this.setContent(),this.on("change",function(){F.update()})},getTemplateId:function(){var a=this.get("tag"),b=this.get("specialTags");return _.indexOf(b,a)>=0?"#"+a:"#"+i},getTemplateClass:function(){var a="width-",b=this.get("tag"),c=this.getAttr("width");return c?j+" "+b+" "+a+c:j+" "+b},setIconClass:function(){this.widgetParadigm.icon&&this.set("iconClass",this.widgetParadigm.icon)},setIconImg:function(){this.widgetParadigm.iconImg&&this.set("iconImg",this.widgetParadigm.iconImg)},setName:function(){this.widgetParadigm.name&&this.set("name",this.widgetParadigm.name)},setContent:function(){this.getAttr("content")?this.set("content",this.getAttr("content")):this.widgetParadigm.formElements.content&&(this.set("content",this.widgetParadigm.formElements.content),this.setAttr("content",this.widgetParadigm.formElements.content))},setWidth:function(){this.getAttr("width")&&o[this.getAttr("width")]&&this.set("width",o[this.getAttr("width")])},getCleanWpShortcode:function(){return this.attributes},getAttrs:function(){return this.getCleanWpShortcode().attrs.named},getAttr:function(a){return this.getCleanWpShortcode().get(a)},setAttr:function(a,b){return this.getCleanWpShortcode().set(a,b)},getForm:function(){var b=this;a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxForm",type:b.getAttr("type"),widgetAttrs:b.getAttrs()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(c){if(c){a("#"+d+"-form-loader").remove();var e=new y({model:b,title:c.title,description:c.description}),f=new v;a("body").append('<div id="'+d+'-overlay"></div>'),a("body").append(e.render().el),e.$el.append(c.form),e.$el.append(f.render().el),this.displaySwitcher=new s({el:e.$el})}}).fail(function(){alert("error")})}}),v=Backbone.View.extend({tagName:"span",initialize:function(){this.template=q.template(a("#"+d+"_widget_form_submit").html())},render:function(){return this.$el.html(this.template({})),this}}),w=Backbone.View.extend({tagName:"div",className:"remove-form",initialize:function(){this.template=q.template(a("#"+d+"_widget_form_remove").html())},render:function(){return this.$el.html(this.template({})),this}}),x=(Backbone.View.extend({el:"#"+d+"-bricklayer-switcher",initialize:function(){this.$titlediv=a("#titlediv"),this.$postdivrich=a("#postdivrich"),this.$pageBuilderWrapper=a("#bricklayer"),this.$displaySwitch=a("#"+d+"_bricklayer_enabled"),this.$postOriginalContent=a("#"+d+"_bricklayer_original_post_content"),this.$postShortcodes=a("#"+d+"_bricklayer_post_shortcodes"),p?this.enable():this.disable(),this.events={},this.events["click #"+d+"-enable"]="enable",this.events["click #"+d+"-disable"]="disable"},render:function(){return this},enable:function(a){a&&a.preventDefault(),this.$pageBuilderWrapper.show(),this.$postdivrich.hide(),this.$el.html(this.getDisableButton()),this.$displaySwitch.prop("checked",!0)},disable:function(a){a&&a.preventDefault(),this.$pageBuilderWrapper.hide(),this.$postdivrich.show(),this.$el.html(this.getEnableButton()),this.$displaySwitch.prop("checked",!1)},getEnableButton:function(){return'<input name="'+d+'-enable" class="button button-primary button-large" id="'+d+'-enable" value="Enable Bricklayer">'},getDisableButton:function(){return'<input name="'+d+'-disable" class="button button-secondary button-large" id="'+d+'-disable" value="Disable Bricklayer">'},handleContent:function(a){}}),Backbone.View.extend({el:"#"+d+"-tabs",initialize:function(a){this.parentView=a.parentView,this.events={},this.events["click #add-row"]="addRow",this.events["click #"+d+"-add-template"]="addTemplate",this.events["click #"+d+"-add-template-brick"]="addTemplateBrick",this.events["click #"+d+"-save-template"]="saveTemplate"},render:function(){return this},addRow:function(a){a.preventDefault(),this.parentView.addRow(a)},addTemplate:function(b){b.preventDefault();var c=a("#"+d+"-template-id").val();a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxGetTemplate",templateId:c},dataType:"json",beforeSend:function(){}}).done(function(a){if(a){var b;wp.shortcode.replace(e,E.getInstanceById("content").getContent(),function(a){b=a.content});var c="";wp.shortcode.replace(e,a.post_content,function(a){c=a.content}),b+=c,E.replaceTags(b),F.render()}})},addTemplateBrick:function(b){b.preventDefault();var c,f=a("#"+d+"-template-id"),g=f.val(),h=f.find(":selected").text(),i='[cbp_widget_row fullwidth="false" type="cbp_widget_row"]';i+='[cbp_widget_box width="one-whole" type="cbp_widget_box"]',i+='[cbp_widget_element type="cbp_widget_template" display_description="'+h+'" css_class="" padding="" template_id="'+g+'"][/cbp_widget_element][/cbp_widget_box][/cbp_widget_row]',wp.shortcode.replace(e,E.getInstanceById("content").getContent(),function(a){c=a.content}),c+=i,E.replaceTags(c),F.render()},saveTemplate:function(b){b.preventDefault();var c=a("#"+d+"-new-template-name").val().trim();if(!c)return void alert("Name is missing");var e=E.getContent();a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxSaveTemplate",templateName:c,temeplateContent:q.stripWrappingTags(e)},dataType:"json",beforeSend:function(){}}).done(function(a){a&&alert("ok"==a.status?"Template Saved!":"Network Error")})}})),y=Backbone.View.extend({tagName:"form",className:d+"-form-modal",initialize:function(b){this.template=q.template(a("#"+d+"_widget_form").html()),this.title=b.title||"",this.description=b.description||""},render:function(){this.$el.html(this.template({title:this.title,description:this.description}));var a=new w;return this.$el.prepend(a.render().el),this},events:{"click #content-element-save":"save","click .remove-form":"remove"},save:function(b){b.preventDefault();var c=this,e={};tinyMCE.triggerSave(),a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxSanitize",type:c.model.getAttr("type"),widgetAttrs:this.$el.serializeArray()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(b){b&&(a("#cbp-form-loader").remove(),_.each(b,function(a){e[a.name]=e.hasOwnProperty(a.name)?e[a.name]+","+a.value:a.name===d+"_content"?a.value:_.escape(a.value),c.model.setAttr(q.deprefixize(a.name),e[a.name])}),c.model.trigger("change"),c.remove())}).fail(function(){alert("error")})},remove:function(){this.$el.remove(),a("#"+d+"-overlay").remove()}}),z=Backbone.View.extend({el:"#"+d+"-page-layout",initialize:function(){this.shortcodesString="",a("#"+d+"-tabs").tabs(),a("#"+d+"-layout-elements li").draggable({appendTo:"#"+d+"-page-layout",helper:"clone",containment:"#wpwrap",scope:"row"}),a("#"+d+"-content-elements li").draggable({appendTo:"#"+d+"-page-layout",helper:"clone",containment:"#wpwrap",scope:"content-box"});new x({parentView:this});this.render()},render:function(){var a=this;return this.reset(),this.buildTree(),D.forEach(function(b){var c=new B({model:b});a.$el.append(c.render().el)}),this.makeDynamic(this.$el.children()),this},events:{"click .content-element-edit":"edit","click .element-remove":"remove","click .width-spinner span":"widthSpinner","click .content-element-duplicate":"duplicate"},addRow:function(a){a.preventDefault();var b=new u(new wp.shortcode({tag:f,attrs:{fullwidth:!1,type:f},type:"closed"}));D.push(b);var c=new A({model:b});c.render().$el.appendTo(this.$el),this.makeDroppable(c.$el)},edit:function(b){var c=a(b.currentTarget).closest("."+j).data("cid");if(c){var d=D.getModelByCid(c);d&&d.getForm()}},remove:function(b){confirm("You are about to delete the element. Are you sure?")&&(a(b.currentTarget).closest("."+j).remove(),this.update())},duplicate:function(b){var c=a(b.currentTarget).closest("."+j),d=c.clone();c.after(d),this.update()},widthSpinner:function(b){var c,d,e,f,g=a(b.currentTarget),h=g.closest("."+j),i=g.attr("class"),k=n.length,l=h.data("cid");l&&(c=D.getModelByCid(l),c&&(f=c.getAttr("width"),d=a.inArray(f,n),"width-up"===i&&d++,"width-down"===i&&d--,0>d&&(d=0),d>=k-1&&(d=k-1),e=n[d],h.removeClass("width-"+f),h.addClass("width-"+e),c.setAttr("width",e),this.update()))},reset:function(){this.shortcodesString="",this.$el.html("")},update:function(){this.updateShortcodesInEditor(),this.render()},updateShortcodesInEditor:function(){this.buildShortcodesString(),E.replaceTags(this.shortcodesString)},makeDynamic:function(b){var c=this;b.each(function(){var b=a(this);q.isRow(b)?(c.makeDroppable(b),b.sortable({cancel:".not-sortable",connectWith:"."+f,stop:function(){c.update()}}).parent().sortable({cancel:".not-sortable",stop:function(){c.update()}})):q.isBox(b)&&(c.makeBoxDroppable(b),b.sortable({cancel:".not-sortable",connectWith:"."+h,stop:function(){c.update()}})),q.hasChildren(b)&&(q.isRow(b)?c.makeDynamic(b.children()):q.isBox(b))})},makeDroppable:function(a,b){var c=this;a.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:b||"row",drop:function(a,b){var d=b.draggable.data("width"),e=new u(new wp.shortcode({tag:h,attrs:{width:d,type:h},type:"closed"}));D.push(e);var f=new A({model:e});f.render().$el.appendTo(this),c.makeBoxDroppable(f.$el),c.update()}})},makeBoxDroppable:function(a){var b=this;a.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:"content-box",drop:function(a,c){var d=c.draggable.data("type"),e=new u(new wp.shortcode({tag:i,attrs:{type:d},type:"closed"}));D.push(e);var f=new A({model:e});f.render().$el.appendTo(this),d===g||b.update()}})},makeRowInnerDroppable:function(a){var b=this;a.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:"row",drop:function(a,c){var d=c.draggable.data("width"),e=new u(new wp.shortcode({tag:h,attrs:{width:d,type:h},type:"closed"}));D.push(e);var f=new A({model:e});f.render().$el.appendTo(this),b.update()}})},buildTree:function(){function a(b,e){e&&wp.shortcode.replace(b,e,function(b){var e=new u(new wp.shortcode({tag:b.tag,attrs:_.extend({},b.attrs.named,{content:q.stripWrappingTags(q.wpautop(b.content))}),type:"closed"}));e.id=b.attrs.named.id,e.getCleanWpShortcode().children=[],b.tag===f&&(c=e,D.push(c),a(h,b.content)),b.tag===h&&(d=e,c.getCleanWpShortcode().children&&(c.getCleanWpShortcode().children.push(d),a(i,b.content))),b.tag===i&&d.getCleanWpShortcode().children&&d.getCleanWpShortcode().children.push(e)})}var b=E.getContent(),c=null,d=null;D.reset(),a(f,b)},buildShortcodesString:function(){function b(c){a.each(c,function(){var c,e=a(this),g="",j="",k=e.data("cid");if(k){var l=D.getModelByCid(k);l&&((e.hasClass(f)||e.hasClass(h))&&(l&&_.each(l.getAttrs(),function(a,b){"content"!==b&&(g+=" "+b+'="'+a+'"')}),d+="["+l.toJSON().tag+g+"]"),c=a(this).children(),c.length&&(e.hasClass(i)&&(l&&_.each(l.getAttrs(),function(a,b){"content"!==b&&(g+=" "+b+'="'+a+'"'),"content"===b&&(j=a)}),d+="["+i+g+"]"+q.stripWrappingTags(q.wpautop(j))),b(c),e.hasClass(i)&&(d+="[/"+i+"]")),(e.hasClass(h)||e.hasClass(f))&&(d+="[/"+l.toJSON().tag+"]"))}})}var c=this.$el.children(),d="";b(c),this.shortcodesString=q.stripWrappingTags(d)}}),A=Backbone.View.extend({tagName:"div",initialize:function(){this.$el.addClass(this.model.getTemplateClass()),this.$el.attr("data-cid",this.model.cid);var b=this.model.getTemplateId();this.template=q.template(a(b).html())},render:function(){return this.$el.html(this.template({model:this.model.toJSON(),helpers:q,partial:function(b,c){return q.template(a("#"+b).html(),c)}})),this}}),B=Backbone.View.extend({tagName:"div",initialize:function(){var b=this.model.get("tag");this.$el.addClass(this.model.getTemplateClass()),this.$el.attr("data-cid",this.model.cid);var c=this.model.getTemplateId(),d=a(c).length?a(c).html():"<span>"+b+" template has not yet been defined</span>";this.template=q.template(d)},render:function(){var b=this,c=this.model.get("children");return this.$el.html(this.template({model:this.model.toJSON(),helpers:q,partial:function(b,c){return q.template(a("#"+b).html(),c)}})),_.each(c,function(a){var c=new B({model:a});b.$el.append(c.render().el)}),this}}),C=Backbone.Collection.extend({url:ajaxurl+"?action=cbpAjaxForm",model:u,getModelByCid:function(a){function b(a,d){a.forEach(function(a){return a.cid===d?void(c=a):void(a.attributes.children&&a.attributes.children.length&&b(a.attributes.children,d))})}var c=null;return b(this.models,a),c}}),D=new C,E=new t,F=(new r,new z)})}(jQuery,window,document);