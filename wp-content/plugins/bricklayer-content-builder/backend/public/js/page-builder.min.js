/*! 05-06-2014 by krivinarius@gmail.com */
!function(a,b){"use strict";a(function(){function c(a){return l.hasOwnProperty(a)?l[a]:{}}var d="cbp",e=d,f=d+"_widget_row",g=d+"_widget_box",h=d+"_widget_element",i=d+"-widget",j=b.cbp_content_builder,k=(j.data.temp,j.data.helpers),l=j.data.widgets,m=j.data.widthClasses,n=j.data.widthClassesObj,o=(j.data.templates,j.data.bl_is_enabled);Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(a){var b=this.__proto__||this.constructor.prototype;return a in this&&(!(a in b)||b[a]!==this[a])}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;for(c=0,d=this.length;d>c;++c)c in this&&a.call(b,this[c],c,this)});var p={};p.template=function(a,b){var c={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},b=b||null;return _.template(a,b,c)},p.isRow=function(a){return a.hasClass(f)},p.isBox=function(a){return a.hasClass(g)},p.hasChildren=function(a){return a.children().length},p.idCounter=0,p.uniqueId=function(a){var b=++this.idCounter+"";return a?a+b:b},p.resetIdCounter=function(){this.idCounter=0},p.getRegex=function(a){return wp.shortcode.regexp(a)},p.wpautop=function(b){return a.trim(b)?switchEditors.wpautop(b):" "},k.stripslashes=p.stripslashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},k.strip_tags=p.strip_tags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},k.trimmer=p.trimmer=function(a,b,c){var c=c||"...";return a?(a.length<=b&&(c=""),this.strip_tags(a.substring(0,b))+c):void 0},k.prefixize=p.prefixize=function(a){return d+"_"+a},k.deprefixize=p.deprefixize=function(a){return"string"==typeof a?a.replace(d+"_",""):void 0},k.removeTinymceIdWrap=p.removeTinymceIdWrap=function(a){if("string"==typeof a){var b=a.replace("wp-","");return b.replace("-wrap","")}},k.stripWrappingTags=p.stripWrappingTags=function(a){return"string"==typeof a?(a=a.replace(/<p>\[/g,"["),a=a.replace(/<p>\s\[/g,"["),a=a.replace(/\]<\/p>/g,"]"),a=a.replace(/\]\s<\/p>/g,"]"),a=a.replace(/<p><\/p>/g,""),a=a.replace(/<p>\s<\/p>/g,""),a=a.replace(/]<br>/g,"]"),a=a.replace(/]\s<br>/g,"]"),a=a.replace(/]<br \/>/g,"]"),a=a.replace(/]\s<br \/>/g,"]"),"</p>\n"===a.substr(0,5)&&(a=a.slice(5)),"<p>\n"===a.substr(-4,4)&&(a=a.slice(0,-4)),"</p>"===a.substr(0,4)&&(a=a.slice(4)),"<p>"===a.substr(-3,3)&&(a=a.slice(0,-3)),a):void 0};var q=Backbone.Model.extend({defaults:{},initialize:function(){j.data.api={},j.data.api.updatePageBuilder=this.updatePageBuilder},updatePageBuilder:function(){E.render()}}),r=Backbone.Model.extend({defaults:{el:null,parentElements:null,dependentElements:null,parentDataType:"triggerparent",childDataType:"triggerchild"},initialize:function(){this.setParentElements(),this.setDependentElements(),this.setInitialStates()},setParentElements:function(){var a=this.get("el").find('[data-type="'+this.get("parentDataType")+'"]');this.set("parentElements",a)},setDependentElements:function(){var a=this.get("el").find('[data-type="'+this.get("childDataType")+'"]');this.set("dependentElements",a)},setInitialStates:function(){var b=this;this.get("dependentElements").each(function(){var c=a(this),d=c.data("parent"),e=c.data("parentstate"),f=b.getParentElement(d);b.setState(c.parents(".cbp_form_element_wrapper"),""+e==""+f.val()),b.registerParentOnChangeEvent(f)})},setState:function(a,b){b?this.show(a):this.hide(a)},getParentElement:function(a){var b=this.get("parentElements").filter('[data-name="'+a+'"]');return b},getChildrenElements:function(a){var b=this.get("dependentElements").filter('[data-parent="'+a+'"]');return b},registerParentOnChangeEvent:function(b){var c=this;b.on("change",function(){var d=c.getChildrenElements(b.data("name"));d.each(function(){var d=a(this);c.setState(d.parents(".cbp_form_element_wrapper"),""+d.data("parentstate")==""+b.val())})})},show:function(a){a.fadeIn()},hide:function(a){a.fadeOut()}}),s=Backbone.Model.extend({getInstanceById:function(a){return"undefined"!=typeof tinyMCE?tinyMCE.get(a):void 0},getContent:function(){var b,c=null;return c="undefined"!=typeof tinyMCE&&(b=this.getInstanceById("content"))&&!b.isHidden()?b.getContent():a("#content").val(),c?c:void 0},replaceTags:function(b){var c=this.getContent(),d=this.getInstanceById("content");b=this.wrapInMainTags(b),this.tagExist(e,c)?(c=c.replace(p.getRegex(e),b),d?d.setContent(c):a("#content").val(c)):d.execCommand("mceInsertContent",!1,b)},tagExist:function(a,b){var c=wp.shortcode.next(e,b);return c?!0:!1},wrapInMainTags:function(a){return"["+e+"]"+a+"[/"+e+"]"}}),t=Backbone.Model.extend({defaults:{specialTags:[f,g],iconClass:"icon-font icon-3x"},initialize:function(){this.widgetParadigm=c(this.getAttr("type")),this.setIconClass(),this.setName(),this.setWidth(),this.setContent(),this.on("change",function(){E.update()})},getTemplateId:function(){var a=this.get("tag"),b=this.get("specialTags");return _.indexOf(b,a)>=0?"#"+a:"#"+h},getTemplateClass:function(){var a="width-",b=this.get("tag"),c=this.getAttr("width");return c?i+" "+b+" "+a+c:i+" "+b},setIconClass:function(){this.widgetParadigm.icon&&this.set("iconClass",this.widgetParadigm.icon)},setName:function(){this.widgetParadigm.name&&this.set("name",this.widgetParadigm.name)},setContent:function(){this.getAttr("content")?this.set("content",this.getAttr("content")):this.widgetParadigm.formElements.content&&(this.set("content",this.widgetParadigm.formElements.content),this.setAttr("content",this.widgetParadigm.formElements.content))},setWidth:function(){this.getAttr("width")&&n[this.getAttr("width")]&&this.set("width",n[this.getAttr("width")])},getCleanWpShortcode:function(){return this.attributes},getAttrs:function(){return this.getCleanWpShortcode().attrs.named},getAttr:function(a){return this.getCleanWpShortcode().get(a)},setAttr:function(a,b){return this.getCleanWpShortcode().set(a,b)},getForm:function(){var b=this;a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxForm",type:b.getAttr("type"),widgetAttrs:b.getAttrs()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(c){if(c){a("#"+d+"-form-loader").remove();var e=new x({model:b,title:c.title,description:c.description}),f=new u;a("body").append('<div id="'+d+'-overlay"></div>'),a("body").append(e.render().el),e.$el.append(c.form),e.$el.append(f.render().el),this.displaySwitcher=new r({el:e.$el})}}).fail(function(){alert("error")})}}),u=Backbone.View.extend({tagName:"span",initialize:function(){this.template=p.template(a("#"+d+"_widget_form_submit").html())},render:function(){return this.$el.html(this.template({})),this}}),v=Backbone.View.extend({tagName:"div",className:"remove-form",initialize:function(){this.template=p.template(a("#"+d+"_widget_form_remove").html())},render:function(){return this.$el.html(this.template({})),this}}),w=(Backbone.View.extend({el:"#"+d+"-bricklayer-switcher",initialize:function(){this.$titlediv=a("#titlediv"),this.$postdivrich=a("#postdivrich"),this.$pageBuilderWrapper=a("#bricklayer"),this.$displaySwitch=a("#"+d+"_bricklayer_enabled"),this.$postOriginalContent=a("#"+d+"_bricklayer_original_post_content"),this.$postShortcodes=a("#"+d+"_bricklayer_post_shortcodes"),o?this.enable():this.disable(),this.events={},this.events["click #"+d+"-enable"]="enable",this.events["click #"+d+"-disable"]="disable"},render:function(){return this},enable:function(a){a&&a.preventDefault(),this.$pageBuilderWrapper.show(),this.$postdivrich.hide(),this.$el.html(this.getDisableButton()),this.$displaySwitch.prop("checked",!0)},disable:function(a){a&&a.preventDefault(),this.$pageBuilderWrapper.hide(),this.$postdivrich.show(),this.$el.html(this.getEnableButton()),this.$displaySwitch.prop("checked",!1)},getEnableButton:function(){return'<input name="'+d+'-enable" class="button button-primary button-large" id="'+d+'-enable" value="Enable Bricklayer">'},getDisableButton:function(){return'<input name="'+d+'-disable" class="button button-secondary button-large" id="'+d+'-disable" value="Disable Bricklayer">'},handleContent:function(a){}}),Backbone.View.extend({el:"#"+d+"-tabs",initialize:function(a){this.parentView=a.parentView,this.events={},this.events["click #add-row"]="addRow",this.events["click #"+d+"-add-template"]="addTemplate",this.events["click #"+d+"-add-template-brick"]="addTemplateBrick",this.events["click #"+d+"-save-template"]="saveTemplate"},render:function(){return this},addRow:function(a){a.preventDefault(),this.parentView.addRow(a)},addTemplate:function(b){b.preventDefault();var c=a("#"+d+"-template-id").val();a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxGetTemplate",templateId:c},dataType:"json",beforeSend:function(){}}).done(function(a){if(a){var b;wp.shortcode.replace(e,D.getInstanceById("content").getContent(),function(a){b=a.content});var c="";wp.shortcode.replace(e,a.post_content,function(a){c=a.content}),b+=c,D.replaceTags(b),E.render()}})},addTemplateBrick:function(b){b.preventDefault();var c,f=a("#"+d+"-template-id"),g=f.val(),h=f.find(":selected").text(),i='[cbp_widget_row fullwidth="false" type="cbp_widget_row"]';i+='[cbp_widget_box width="one-whole" type="cbp_widget_box"]',i+='[cbp_widget_element type="cbp_widget_template" display_description="'+h+'" css_class="" padding="" template_id="'+g+'"][/cbp_widget_element][/cbp_widget_box][/cbp_widget_row]',wp.shortcode.replace(e,D.getInstanceById("content").getContent(),function(a){c=a.content}),c+=i,D.replaceTags(c),E.render()},saveTemplate:function(b){b.preventDefault();var c=a("#"+d+"-new-template-name").val().trim();if(!c)return void alert("Name is missing");var e=D.getContent();a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxSaveTemplate",templateName:c,temeplateContent:p.stripWrappingTags(e)},dataType:"json",beforeSend:function(){}}).done(function(a){a&&alert("ok"==a.status?"Template Saved!":"Network Error")})}})),x=Backbone.View.extend({tagName:"form",className:d+"-form-modal",initialize:function(b){this.template=p.template(a("#"+d+"_widget_form").html()),this.title=b.title||"",this.description=b.description||""},render:function(){this.$el.html(this.template({title:this.title,description:this.description}));var a=new v;return this.$el.prepend(a.render().el),this},events:{"click #content-element-save":"save","click .remove-form":"remove"},save:function(b){b.preventDefault();var c=this,e={};tinyMCE.triggerSave(),a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxSanitize",type:c.model.getAttr("type"),widgetAttrs:this.$el.serializeArray()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(b){b&&(a("#cbp-form-loader").remove(),_.each(b,function(a){e[a.name]=e.hasOwnProperty(a.name)?e[a.name]+","+a.value:a.name===d+"_content"?a.value:_.escape(a.value),c.model.setAttr(p.deprefixize(a.name),e[a.name])}),c.model.trigger("change"),c.remove())}).fail(function(){alert("error")})},remove:function(){this.$el.remove(),a("#"+d+"-overlay").remove()}}),y=Backbone.View.extend({el:"#"+d+"-page-layout",initialize:function(){this.shortcodesString="",a("#"+d+"-tabs").tabs(),a("#"+d+"-layout-elements li").draggable({appendTo:"#"+d+"-page-layout",helper:"clone",containment:"body",scope:"row"}),a("#"+d+"-content-elements li").draggable({appendTo:"#"+d+"-page-layout",helper:"clone",containment:"body",scope:"content-box"});new w({parentView:this});this.render()},render:function(){var a=this;return this.reset(),this.buildTree(),C.forEach(function(b){var c=new A({model:b});a.$el.append(c.render().el)}),this.makeDynamic(this.$el.children()),this},events:{"click .content-element-edit":"edit","click .element-remove":"remove","click .width-spinner span":"widthSpinner","click .content-element-duplicate":"duplicate"},addRow:function(a){a.preventDefault();var b=new t(new wp.shortcode({tag:f,attrs:{fullwidth:!1,type:f},type:"closed"}));C.push(b);var c=new z({model:b});c.render().$el.appendTo(this.$el),this.makeDroppable(c.$el)},edit:function(b){var c=a(b.currentTarget).closest("."+i).data("cid");if(c){var d=C.getModelByCid(c);d&&d.getForm()}},remove:function(b){a(b.currentTarget).closest("."+i).remove(),this.update()},duplicate:function(b){var c=a(b.currentTarget).closest("."+i),d=c.clone();c.parent().append(d),this.update()},widthSpinner:function(b){var c,d,e,f,g=a(b.currentTarget),h=g.closest("."+i),j=g.attr("class"),k=m.length,l=h.data("cid");l&&(c=C.getModelByCid(l),c&&(f=c.getAttr("width"),d=a.inArray(f,m),"width-up"===j&&d++,"width-down"===j&&d--,0>d&&(d=0),d>=k-1&&(d=k-1),e=m[d],h.removeClass("width-"+f),h.addClass("width-"+e),c.setAttr("width",e),this.update()))},reset:function(){this.shortcodesString="",this.$el.html("")},update:function(){this.updateShortcodesInEditor(),this.render()},updateShortcodesInEditor:function(){this.buildShortcodesString(),D.replaceTags(this.shortcodesString)},makeDynamic:function(b){var c=this;b.each(function(){var b=a(this);p.isRow(b)?(c.makeDroppable(b),b.sortable({cancel:".not-sortable",connectWith:"."+f,stop:function(){c.update()}}).parent().sortable({cancel:".not-sortable",stop:function(){c.update()}})):p.isBox(b)&&(c.makeBoxDroppable(b),b.sortable({cancel:".not-sortable",connectWith:"."+g,stop:function(){c.update()}})),p.hasChildren(b)&&(p.isRow(b)?c.makeDynamic(b.children()):p.isBox(b))})},makeDroppable:function(a,b){var c=this;a.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:b||"row",drop:function(a,b){var d=b.draggable.data("width"),e=new t(new wp.shortcode({tag:g,attrs:{width:d,type:g},type:"closed"}));C.push(e);var f=new z({model:e});f.render().$el.appendTo(this),c.makeBoxDroppable(f.$el),c.update()}})},makeBoxDroppable:function(a){var b=this;a.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:"content-box",drop:function(a,c){var d=c.draggable.data("type"),e=new t(new wp.shortcode({tag:h,attrs:{type:d},type:"closed"}));C.push(e);var f=new z({model:e});f.render().$el.appendTo(this),b.update()}})},buildTree:function(){function a(b,e){e&&wp.shortcode.replace(b,e,function(b){var e=new t(new wp.shortcode({tag:b.tag,attrs:_.extend({},b.attrs.named,{content:p.stripWrappingTags(p.wpautop(b.content))}),type:"closed"}));e.getCleanWpShortcode().children=[],b.tag===f&&(c=e,C.push(c),a(g,b.content)),b.tag===g&&(d=e,c.getCleanWpShortcode().children&&(c.getCleanWpShortcode().children.push(d),a(h,b.content))),b.tag===h&&d.getCleanWpShortcode().children&&d.getCleanWpShortcode().children.push(e)})}var b=D.getContent(),c=null,d=null;C.reset(),a(f,b)},buildShortcodesString:function(){function b(c){a.each(c,function(){var c,e=a(this),i="",j="",k=e.data("cid");if(k){var l=C.getModelByCid(k);l&&((e.hasClass(f)||e.hasClass(g))&&(l&&_.each(l.getAttrs(),function(a,b){"content"!==b&&(i+=" "+b+'="'+a+'"')}),d+="["+l.toJSON().tag+i+"]"),c=a(this).children(),c.length&&(e.hasClass(h)&&(l&&_.each(l.getAttrs(),function(a,b){"content"!==b&&(i+=" "+b+'="'+a+'"'),"content"===b&&(j=a)}),d+="["+h+i+"]"+p.stripWrappingTags(p.wpautop(j))),b(c),e.hasClass(h)&&(d+="[/"+h+"]")),(e.hasClass(g)||e.hasClass(f))&&(d+="[/"+l.toJSON().tag+"]"))}})}var c=this.$el.children(),d="";b(c),this.shortcodesString=p.stripWrappingTags(d)}}),z=Backbone.View.extend({tagName:"div",initialize:function(){this.$el.addClass(this.model.getTemplateClass()),this.$el.attr("data-cid",this.model.cid);var b=this.model.getTemplateId();this.template=p.template(a(b).html())},render:function(){return this.$el.html(this.template({model:this.model.toJSON(),helpers:p,partial:function(b,c){return p.template(a("#"+b).html(),c)}})),this}}),A=Backbone.View.extend({tagName:"div",initialize:function(){var b=this.model.get("tag");this.$el.addClass(this.model.getTemplateClass()),this.$el.attr("data-cid",this.model.cid);var c=this.model.getTemplateId(),d=a(c).length?a(c).html():"<span>"+b+" template has not yet been defined</span>";this.template=p.template(d)},render:function(){var b=this,c=this.model.get("children");return this.$el.html(this.template({model:this.model.toJSON(),helpers:p,partial:function(b,c){return p.template(a("#"+b).html(),c)}})),_.each(c,function(a){var c=new A({model:a});b.$el.append(c.render().el)}),this}}),B=Backbone.Collection.extend({url:ajaxurl+"?action=cbpAjaxForm",model:t,getModelByCid:function(a){function b(a,d){a.forEach(function(a){return a.cid===d?void(c=a):void(a.attributes.children&&a.attributes.children.length&&b(a.attributes.children,d))})}var c=null;return b(this.models,a),c}}),C=new B,D=new s,E=(new q,new y)})}(jQuery,window,document);
