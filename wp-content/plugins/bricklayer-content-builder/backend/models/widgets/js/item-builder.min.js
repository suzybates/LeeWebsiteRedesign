/*! 05-06-2014 by krivinarius@gmail.com */
!function(a,b){"use strict";function c(){var a=x.val();a&&wp.shortcode.replace(j,a,function(a){var b={};_.each(a.attrs.named,function(a,c){b[c]=a}),b.content=a.content,y.push(b)})}var d="cbp",e=b.cbp_content_builder,f=e.data.helpers,g=e.data.temp.widget_element_items&&e.data.temp.widget_element_items.subwidget_id?e.data.temp.widget_element_items.subwidget_id:"",h=e.data.temp.widget_element_items&&e.data.temp.widget_element_items.enable_tags?e.data.temp.widget_element_items.enable_tags:!1,i=e.data.temp.widget_element_items&&e.data.temp.widget_element_items.hasOwnProperty("use_save_all_item")&&e.data.temp.widget_element_items.use_save_all_item===!1?!1:!0,j=d+"_widget_element_item";Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(a){var b=this.__proto__||this.constructor.prototype;return a in this&&(!(a in b)||b[a]!==this[a])}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;for(c=0,d=this.length;d>c;++c)c in this&&a.call(b,this[c],c,this)});var k={};k.template=function(a,b){var c={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},b=b||null;return _.template(a,b,c)},k.isRow=function(a){return a.hasClass(TAG_ROW)},k.isBox=function(a){return a.hasClass(TAG_BOX)},k.hasChildren=function(a){return a.children().length},k.idCounter=0,k.uniqueId=function(a){var b=++this.idCounter+"";return a?a+b:b},k.resetIdCounter=function(){this.idCounter=0},k.getRegex=function(a){return wp.shortcode.regexp(a)},k.wpautop=function(a){return switchEditors.wpautop(a)},f.stripslashes=k.stripslashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return b}})},f.strip_tags=k.strip_tags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},f.trimmer=k.trimmer=function(a,b,c){var c=c||"...";return a?this.strip_tags(a.substring(0,b))+c:void 0},f.prefixize=k.prefixize=function(a){return d+"_"+a},f.deprefixize=k.deprefixize=function(a){return"string"==typeof a?a.replace(d+"_",""):void 0},f.removeTinymceIdWrap=k.removeTinymceIdWrap=function(a){if("string"==typeof a){var b=a.replace("wp-","");return b.replace("-wrap","")}},f.stripWrappingTags=k.stripWrappingTags=function(a){return"string"==typeof a?(a=a.replace(/<p>\[/g,"["),a=a.replace(/\]<\/p>/g,"]"),a=a.replace(/<p><\/p>/g,""),a=a.replace(/]<br>/g,"]"),a=a.replace(/]<br \/>/g,"]"),"</p>\n"===a.substr(0,5)&&(a=a.slice(5)),"<p>\n"===a.substr(-4,4)&&(a=a.slice(0,-4)),"</p>"===a.substr(0,4)&&(a=a.slice(4)),"<p>"===a.substr(-3,3)&&(a=a.slice(0,-3)),a):void 0};var l=Backbone.Model.extend({defaults:{el:null,parentElements:null,dependentElements:null,parentDataType:"triggerparent",childDataType:"triggerchild"},initialize:function(){this.setParentElements(),this.setDependentElements(),this.setInitialStates()},setParentElements:function(){var a=this.get("el").find('[data-type="'+this.get("parentDataType")+'"]');this.set("parentElements",a)},setDependentElements:function(){var a=this.get("el").find('[data-type="'+this.get("childDataType")+'"]');this.set("dependentElements",a)},setInitialStates:function(){var b=this;this.get("dependentElements").each(function(){var c=a(this),d=c.data("parent"),e=c.data("parentstate"),f=b.getParentElement(d);b.setState(c.parents(".cbp_form_element_wrapper"),""+e==""+f.val()),b.registerParentOnChangeEvent(f)})},setState:function(a,b){b?this.show(a):this.hide(a)},getParentElement:function(a){var b=this.get("parentElements").filter('[data-name="'+a+'"]');return b},getChildrenElements:function(a){var b=this.get("dependentElements").filter('[data-parent="'+a+'"]');return b},registerParentOnChangeEvent:function(b){var c=this;b.on("change",function(){var d=c.getChildrenElements(b.data("name"));d.each(function(){var d=a(this);c.setState(d.parents(".cbp_form_element_wrapper"),""+d.data("parentstate")==""+b.val())})})},show:function(a){a.fadeIn()},hide:function(a){a.fadeOut()}}),m=(Backbone.Model.extend({getInstanceById:function(a){return"undefined"!=typeof tinyMCE?tinyMCE.getInstanceById(a):void 0},getContent:function(){var b,c=null;return c="undefined"!=typeof tinyMCE&&(b=this.getInstanceById("content"))&&!b.isHidden()?b.getContent():a("#content").val(),c?c:void 0},replaceTags:function(b){var c=this.getContent(),d=this.getInstanceById("content");b=this.wrapInMainTags(b),this.tagExist(TAG_MAIN,c)?(c=c.replace(k.getRegex(TAG_MAIN),b),d?d.setContent(c):a("#content").val(c)):d.execCommand("mceInsertContent",!1,b)},tagExist:function(a,b){var c=wp.shortcode.next(TAG_MAIN,b);return c?!0:!1},wrapInMainTags:function(a){return"["+TAG_MAIN+"]"+a+"[/"+TAG_MAIN+"]"}}),Backbone.Model.extend({defaults:{name:"",shortcode:"",position:1e4},initialize:function(){this.id||(this.id=this.generateID(),this.set("id",this.generateID()))},generateID:function(){return"_"+Math.random().toString(36).substr(2,9)},getForm:function(){var b=this;a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxForm",type:g,widgetAttrs:b.toJSON()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(c){if(c){a("#cbp-form-loader").remove();var d=new r({model:b,title:c.title,description:c.description}),e=new o;a("body").append(d.render().el),d.$el.append(c.form),d.$el.append(e.render().el),this.displaySwitcher=new l({el:d.$el})}})}})),n=Backbone.Model.extend({defaults:{name:"",slug:""},initialize:function(){this.set("name",a.trim(this.get("name"))),this.set("slug",this.generateSlug(this.get("name")))},generateSlug:function(a){return a.toLowerCase().replace(/-+/g,"").replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")}}),o=Backbone.View.extend({tagName:"span",initialize:function(){this.template=k.template(a("#"+d+"_widget_form_submit").html())},render:function(){return this.$el.html(this.template({})),this}}),p=Backbone.View.extend({tagName:"div",className:"remove-form",initialize:function(){this.template=k.template(a("#"+d+"_widget_form_remove").html())},render:function(){return this.$el.html(this.template({})),this}}),q=Backbone.View.extend({el:"#create-item",initialize:function(){this.template=k.template(a("#create_item_template").html())},render:function(b){var b=b||{};return this.$el.html(this.template({helpers:k,options:b,partial:function(b,c){return k.template(a("#"+b).html(),c)}})),this},events:{"click #add-item":"add"},add:function(a){a.preventDefault();var b,c=this.$("#new-item-name"),d=c.val().trim(),e=c.data("type"),f=y.where({name:d});return f[0]?void alert(e.charAt(0).toUpperCase()+e.slice(1)+" by that name already exists"):(d?b=new m({name:d,type:e}):alert("Name is missing"),y.add(b),z.prepend(E.render(y).el),void c.val(""))}}),r=Backbone.View.extend({tagName:"form",className:d+"-form-modal",initialize:function(b){this.template=k.template(a("#"+d+"_widget_form").html()),this.title=b.title||"",this.description=b.description||""},render:function(){this.$el.html(this.template({title:this.title,description:this.description}));var a=new p;return this.$el.prepend(a.render().el),this},events:{"click #content-element-save":"save","click .remove-form":"remove"},save:function(b){b.preventDefault();var c=this,d={};tinyMCE.triggerSave(),a.ajax({url:ajaxurl,type:"POST",data:{action:"cbpAjaxSanitize",type:g,widgetAttrs:this.$el.serializeArray()},dataType:"json",beforeSend:function(){a("body").append('<div id="cbp-form-loader"></div>')}}).done(function(b){b&&(a("#cbp-form-loader").remove(),_.each(b,function(a){d[a.name]=d.hasOwnProperty(a.name)?d[a.name]+","+a.value:a.value,c.model.set(k.deprefixize(a.name),d[a.name])}),c.model.trigger("change"),c.remove(),z.prepend(E.render(y).el),i||C.$el.find("#save-all").trigger("click"))})},remove:function(){this.$el.remove()}}),s=Backbone.View.extend({tagName:"ul",attributes:{id:"item-list","class":"padded"},initialize:function(){this.$el.sortable({stop:function(){E.$el.children().each(function(){a(this).trigger("change:position")})}})},render:function(a){var b=this;return this.clear(),a.forEach(function(a){var c=new t({model:a});b.$el.append(c.render().el)}),this},clear:function(){this.$el.html("")}}),t=Backbone.View.extend({tagName:"li",attributes:{"class":"list-item"},initialize:function(){this.template=k.template(a("#item_template").html())},render:function(){return this.$el.html(this.template({model:this.model.toJSON(),helpers:k,partial:function(b,c){return k.template(a("#"+b).html(),c)}})),this},events:{"click .item-edit":"show","click .item-delete":"remove","change:position":"setPosition"},show:function(a){a.preventDefault(),this.model.getForm()},remove:function(){y.remove(this.model),z.prepend(E.render(y).el)},setPosition:function(){this.model.set("position",this.$el.index())}}),u=Backbone.View.extend({el:"#save-all-form",initialize:function(){this.template=k.template(a("#save_all_form_template").html())},render:function(){return this.$el.html(this.template({helpers:k,partial:function(b,c){return k.template(a("#"+b).html(),c)}})),this},events:{"click #save-all":"saveAll"},saveAll:function(b){b.preventDefault();var c=this;E.$el.children().each(function(){a(this).trigger("change:position")});var d=_.sortBy(y.models,function(a){return a.get("position")});d.forEach(function(a){c.makeShortcodes(a)});var e="";d.forEach(function(a){e+=k.stripWrappingTags(a.get("shortcode"))}),x.val(k.stripslashes(e)),h&&(B.setTags(),A.val(B.toString())),i&&alert("All items saved!")},makeShortcodes:function(a){function b(a){if(a.id){c+="["+j;for(var b in a.attributes)"content"!==b&&(c+=" "+b+'="'+a.attributes[b]+'"');var d=a.get("content");c+=d?"]"+k.wpautop(d):"]",c+="[/"+j+"]"}}var c="";b(a),a.set("shortcode",c)}}),v=Backbone.Collection.extend({url:ajaxurl+"?action=slideBuilderAjax",model:m,comparator:function(a){return a.get("position")}}),w=Backbone.Collection.extend({url:ajaxurl+"?action=slideBuilderAjax",model:n,comparator:function(a){return a.get("position")},toString:function(){var a="";return this.models.forEach(function(b,c){var d=c?"|":"";b.get("name")&&b.get("slug")&&(a+=d+b.get("name")+";",a+=b.get("slug"))}),a},loadFromString:function(a){var b=this,c=a.split("|");_.each(c,function(a){var c=a.split(";");b.add({name:c[0],slug:c[1]})})},setTags:function(){B.reset(),y.models.forEach(function(a){var b=a.get("tags").split(",");_.each(b,function(a){var b=new n({name:a}),c=B.where({slug:b.get("slug")});c[0]||B.add(b)})})}}),x=a("#"+d+"-items-content"),y=new v,z=a("#items-container");if(h){var A=a("#"+d+"_tags"),B=new w;B.loadFromString(A.val())}c();var C=new u,D=new q,E=new s;C.render(),z.append(E.render(y).el),D.render()}(jQuery,window,document);