/*! 11-08-2013 by krivinarius@gmail.com */
(function(t,e){function n(t){return t?o(t):undefined}function o(t){for(var e in n.prototype)t[e]=n.prototype[e];return t}function i(e,o){this.element=e,this.options=t.extend({},l,o),this._defaults=l,this._name=s,this.emitter=new n,this.count=0,this.elementTree=[],this.allElements={},this.$pageBuilderContainer=t("#fwidgets-page-content ul"),this.$addRowButton=t(this.element).children("#add-row"),this.$addFulwidthRowButton=t(this.element).children("#add-row-fullwidth"),this.init()}function a(e){this.id=e.id,this.type=e.attrs.type;var n=t.extend(!0,{},r(this.type));this.formElements=n.formElements,this.setFormElements(e)}function r(t){return w.hasOwnProperty(t)?w[t]:undefined}var s="FWidgets",l={count:0,rowClass:"row",spanClass:"element-container",contentElementClass:"content-element",allElements:{},elementTree:[],$pageBuilderContainer:t("#fwidgets-page-content ul"),$addRowButton:t(this.element).children("#add-row")},p="towpb",c="towpb_widget_row",d="towpb_widget_box",h="towpb_widget_element",u="towpb-fullwidth",m="content-element-edit",f="element-remove",g=e.TOW,v=g.towpb.temp,y=g.towpb.helpers,w=g.towpb.widgets,b=g.towpb.widthClasses;n.prototype.on=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks[t]=this._callbacks[t]||[]).push(e),this},n.prototype.once=function(t,e){function n(){o.off(t,n),e.apply(this,arguments)}var o=this;return this._callbacks=this._callbacks||{},e._off=n,this.on(t,n),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks[t];if(!n)return this;if(1==arguments.length)return delete this._callbacks[t],this;var o=index(n,e._off||e);return~o&&n.splice(o,1),this},n.prototype.emit=function(t){this._callbacks=this._callbacks||{};var e=[].slice.call(arguments,1),n=this._callbacks[t];if(n){n=n.slice(0);for(var o=0,i=n.length;i>o;++o)n[o].apply(this,e)}return this},n.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks[t]||[]},n.prototype.hasListeners=function(t){return!!this.listeners(t).length},Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(t){var e=this.__proto__||this.constructor.prototype;return t in this&&(!(t in e)||e[t]!==this[t])}),i.prototype.init=function(){this.parsePageShortcodesInitial(),this.registerEvents()},i.prototype.updateModel=function(){},i.prototype.parsePageShortcodesInitial=function(){function e(o){o.each(function(){var o=t(this);n.isRow(o)?n.makeDroppable(o):n.isBox(o)&&(n.makeSpanDroppable(o),o.sortable({connectWith:"."+d,stop:function(){n.makeShortcodesFromHtml()}}).parent().sortable()),n.hasChildren(o)&&(n.isRow(o)?e(o.children()):n.isBox(o))})}var n=this;this.reset(),this.parseShortcodes();var o=this.makeHtmlFromTree(),i=t(o);this.append(i),e(i)},i.prototype.parseShortcodes=function(){function t(n,a){a&&wp.shortcode.replace(n,a,function(n){n.children=[],n.tag===c&&""!==n.content&&(o=n,e.elementTree.push(n),t(d,n.content)),n.tag===d&&(i=n,o.children.push(n),t(h,n.content)),n.tag===h&&i.children.push(n)})}var e=this,n=this.getEditorContent(),o=null,i=null;t(c,n)},i.prototype.makeHtmlFromTree=function(){function t(o){var i,a=o.length;for(i=0;a>i;i++){var s=o[i],l=e.generateUniqueIdString(),p={id:l,attrs:s.attrs.named,tag:s.tag};p.attrs.content=s.content,e.create(p);var m=s.tag,f=s.attrs.named.width,g=s.attrs.named.type;s.content;var v,y,w=s.children;m===c&&(y="true"===s.attrs.named.fullwidth?" "+u:"",n+='<li class="'+c+y+'" data-id="'+l+'">'+e.getRemoveLinkHtml()+e.getEditLinkHtml()),m===d&&(n+='<div class="'+d+" width-"+f+'" data-width="'+f+'" data-id="'+l+'">'+e.getRemoveLinkHtml()+e.getEditLinkHtml()+e.getSpinnerHtml()),m===h&&(v=r(g),n+='<p class="'+h+" "+g+'" data-id="'+l+'">'+e.getIconHtml(v.icon)+'<span class="towpb-widget-title">'+v.name+"</span>"+e.getRemoveLinkHtml()+e.getEditLinkHtml()),w.length>0&&t(w),m===h&&(n+="</p>"),m===d&&(n+="</div>"),m===c&&(n+="</li>")}}var e=this;console.log("elementTree:",this.elementTree);var n="";return t(this.elementTree),console.log("allElements:",this.allElements),n},i.prototype.makeShortcodesFromHtml=function(){function e(o){t.each(o,function(){var o,a=t(this),r="",s="",l=a.data("id"),p=n.getElementById(l);a.hasClass(c)&&(p&&(t.each(p.formElements,function(t,e){"content"!==t&&(r+=" "+t+'="'+e.value+'"')}),r+=' type="'+p.type+'"'),i+="["+c+r+"]"),a.hasClass(d)&&(p&&(t.each(p.formElements,function(t,e){"content"!==t&&(r+=" "+t+'="'+e.value+'"')}),r+=' type="'+p.type+'"'),i+="["+d+r+"]"),o=t(this).children(),o.length&&(a.hasClass(h)&&(p&&(t.each(p.formElements,function(t,e){"content"!==t&&(r+=" "+t+'="'+e.value+'"'),"content"===t&&(s=e.value)}),r+=' type="'+p.type+'"'),i+="["+h+r+"]"+s),e(o),a.hasClass(h)&&(i+="[/"+h+"]")),a.hasClass(d)&&(i+="[/"+d+"]"),a.hasClass(c)&&(i+="[/"+c+"]")})}var n=this,o=this.$pageBuilderContainer.children(),i="";e(o),i=this.wrapInMainTags(i),i=this.stripWrappingTags(i),i=this.wpautop(i),this.replaceShortcodesInEditor(i)},i.prototype.getEditorContent=function(){var e=null;return e="undefined"!=typeof tinyMCE&&(ed=tinyMCE.getInstanceById("content"))&&!ed.isHidden()?ed.getContent():t("#content").val(),e?e:undefined},i.prototype.replaceShortcodesInEditor=function(e){var n=this.getEditorContent(),o=tinyMCE.getInstanceById("content");this.mainTagsExist(n)?(n=n.replace(this.getRegex(p),e),o?o.setContent(n):t("#content").val(n)):o.execCommand("mceInsertContent",!1,e)},i.prototype.registerEvents=function(){var e=this,n=t("#fwidgets-page-content ul");n.sortable({stop:function(){e.makeShortcodesFromHtml()}}),t("#fw-tabs").tabs(),this.$addRowButton.on("click",function(o){o.preventDefault();var i=e.generateUniqueIdString(),a=t('<li class="'+c+'" data-id="'+i+'">'+e.getRemoveLinkHtml()+"</li>");n.append(a);var r={id:i,attrs:{fullwidth:!1,type:c},tag:c};e.create(r),e.makeDroppable(a)}),this.$addFulwidthRowButton.on("click",function(o){o.preventDefault();var i=e.generateUniqueIdString(),a=t('<li class="'+c+" "+u+'" data-id="'+i+'">'+e.getRemoveLinkHtml()+"</li>");n.append(a);var r={id:i,attrs:{fullwidth:!0,type:c},tag:c};e.create(r),e.makeDroppable(a)}),t("#layout-elements li").draggable({appendTo:"body",helper:"clone",scope:"row"}),t("#content-elements li").draggable({appendTo:"body",helper:"clone",scope:"content-box"}),this.$pageBuilderContainer.on("click",".content-element-edit",function(){e.removeForm();var n,o=t(this),i=o.parent().data("id");n=e.allElements[i],n&&t.ajax({url:ajaxurl,type:"POST",data:{action:"ajaxForm",id:i,type:n.type,formElements:n.formElements},beforeSend:function(){}}).done(function(e){e&&t("body").append('<div id="overlay"></div><div class="form-modal"><span class="remove-form">x</span>'+e+"</div>")})}),this.$pageBuilderContainer.on("click","."+f,function(){var n=t(this).parent();n.data("id"),n.remove(),e.makeShortcodesFromHtml(),e.parsePageShortcodesInitial()}),t("body").on("click","#content-element-save",function(t){t.preventDefault(),e.saveForm()}),t("body").on("click",".remove-form",function(){e.removeForm()}),t("body").on("click",".remove-form-more",function(){e.removeFormMore()}),t("body").on("click",".towpb-more",function(e){e.preventDefault();var n=t(this),o=n.data("ajax"),i=n.data("id");t.ajax({url:ajaxurl,type:"POST",data:{action:o,data:v,id:i},beforeSend:function(){}}).done(function(e){e&&t("body").append('<div class="form-modal-more"><span class="remove-form-more">x</span><form id="'+i+'">'+e+"</form></div>")})}),this.$pageBuilderContainer.on("click",".width-spinner span",function(){var n,o=t(this),i=o.parent().parent(),a=o.attr("class"),r=b.length,s=i.data("id"),l=i.data("width"),p=t.inArray(l,b);i.removeClass("width-"+l),"width-up"===a&&p++,"width-down"===a&&p--,0>p&&(p=0),p>=r-1&&(p=r-1),n=b[p],i.addClass("width-"+n),i.data("width",n),e.allElements[s].formElements.width.value=n,e.makeShortcodesFromHtml()})},i.prototype.makeDroppable=function(e,n){var o=this;e.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:n||"row",drop:function(e,n){var i=n.draggable.data("width"),a=o.generateUniqueIdString(),r=t(o.getContainerHtml(i,a));r.appendTo(this);var s={id:a,attrs:{width:i,type:d},tag:d};o.create(s),o.makeSpanDroppable(r),r.sortable({connectWith:"."+d,stop:function(){o.makeShortcodesFromHtml()}}).parent().sortable(),o.makeShortcodesFromHtml()}})},i.prototype.makeSpanDroppable=function(e){var n=this;e.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",scope:"content-box",drop:function(e,o){var i=o.draggable.data("type"),a=n.generateUniqueIdString(),s=r(i);t('<p class="'+h+'" data-id="'+a+'">'+n.getIconHtml(s.icon)+s.name+n.getRemoveLinkHtml()+n.getEditLinkHtml()+"</p>").appendTo(this);var l={id:a,attrs:{type:i},tag:h};n.create(l),n.makeShortcodesFromHtml()}})},i.prototype.getContainerHtml=function(t,e){var n="";return"one-whole"===t&&(n='<div class="width-'+t+" "+d+'" data-width="'+t+'" data-id="'+e+'">'+this.getRemoveLinkHtml()+this.getSpinnerHtml()+"</div>"),"one-half"===t&&(n='<div class="width-'+t+" "+d+'" data-width="'+t+'" data-id="'+e+'">'+this.getRemoveLinkHtml()+this.getSpinnerHtml()+"</div>"),"one-third"===t&&(n='<div class="width-'+t+" "+d+'" data-width="'+t+'" data-id="'+e+'">'+this.getRemoveLinkHtml()+this.getSpinnerHtml()+"</div>"),n},i.prototype.create=function(t){var e=!1;(t.tag===c||t.tag===d||t.tag===h)&&this.isRegisteredWidgetType(t.attrs.type)&&(e=new a(t)),e&&(this.allElements[t.id]=e,console.log("element",t.id,"created"))},a.prototype.setFormElements=function(e){var n=this;t.each(e.attrs,function(t,e){n.formElements[t]&&(n.formElements[t].value=e)})},i.prototype.tags=function(t,e){var n="<"+t,o="</"+t+">";for(var i in e)n+=" "+i+'="'+e[attrib]+'"';return n+=">",{openingTag:n,closingTag:o}},i.prototype.wrapInMainTags=function(t){return"["+p+"]"+t+"[/"+p+"]"},i.prototype.mainTagsExist=function(t){var e=wp.shortcode.next(p,t);return e?!0:!1},i.prototype.getEditLinkHtml=function(){return'<span class="'+m+'">edit</span>'},i.prototype.getRemoveLinkHtml=function(){return'<span class="'+f+'">x</span>'},i.prototype.getSpinnerHtml=function(){return'<div class="width-spinner"><span class="width-down">-</span><span class="width-up">+</span></div>'},i.prototype.getIconHtml=function(t){return'<span class="'+t+'"></span>'},i.prototype.isRow=function(t){return t.hasClass(c)},i.prototype.isBox=function(t){return t.hasClass(d)},i.prototype.hasChildren=function(t){return t.children().length},i.prototype.generateUniqueIdString=function(){return"element_"+this.count++},i.prototype.append=function(t){this.$pageBuilderContainer.append(t)},i.prototype.getRegex=function(t){return wp.shortcode.regexp(t)},i.prototype.reset=function(){this.allElements={},this.elementTree=[],this.count=0,this.$pageBuilderContainer.empty()},i.prototype.getElementById=function(t){return this.allElements[t]},i.prototype.isRegisteredWidgetType=function(t){return w.hasOwnProperty(t)},i.prototype.wpautop=function(t){return switchEditors.wpautop(t)},i.prototype.stripWrappingTags=function(t){return"string"==typeof t?(t=t.replace("<p>[","["),t=t.replace("]</p>","]"),t=t.replace("<p></p>",""),t=t.replace("]<br />","]")):undefined},i.prototype.prefixize=function(t){return"towpb_"+t},i.prototype.deprefixize=function(t){return"string"==typeof t?t.replace("towpb_",""):undefined},i.prototype.removeTinymceIdWrap=function(t){if("string"==typeof t){var e=t.replace("wp-","");return e.replace("-wrap","")}},y.stripslashes=function(t){return(t+"").replace(/\\(.?)/g,function(t,e){switch(e){case"\\":return"\\";case"0":return"\0";case"":return"";default:return e}})},y.prefixize=function(t){return"towpb-"+t},y.deprefixize=function(t){return"string"==typeof t?t.replace("towpb-",""):undefined},y.removeTinymceIdWrap=function(t){if("string"==typeof t){var e=t.replace("wp-","");return e.replace("-wrap","")}},y.stripWrappingTags=function(t){return"string"==typeof t?(t=t.replace("<p>[","["),t=t.replace("]</p>","]"),t=t.replace("<p></p>",""),t=t.replace("]<br />","]")):undefined},i.prototype.removeForm=function(){t("body").find(".form-modal").remove(),t("body").find("#overlay").remove()},i.prototype.removeFormMore=function(){t("body").find(".form-modal-more").remove()},i.prototype.saveForm=function(){var e=this,n=t("#element-form"),o=n.data("id"),i=n.serializeArray();t.each(i,function(){var n=this.value,i=this.name;i=e.deprefixize(i),t.each(e.allElements[o].formElements,function(t,e){t===i&&(e.value=TOW.towpb.helpers.stripslashes(n))});var a=e.removeTinymceIdWrap(i),r=tinyMCE.getInstanceById(e.prefixize(a));if(r){var s=r.getContent();e.allElements[o].formElements[a].value=s}}),e.removeForm(),e.makeShortcodesFromHtml(),e.parsePageShortcodesInitial()},t.fn[s]=function(e){return this.each(function(){t.data(this,"plugin_"+s)||t.data(this,"plugin_"+s,new i(this,e))})},t(function(){t("#fwidgets")[s]()})})(jQuery,window,document);